/**
 * Chrome EQ & Volume Boost
 * Copyright (c) 2025 Jussi Torres (Zyntra Labs)
 * Licensed under the MIT License.
 *
 * Developed by Jussi Torres
 */

let bass,mid,treble,compressor,audioContext=null,sourceNode=null,gainNode=null,analyser=null;function createFilter(e,t){const a=audioContext.createBiquadFilter();return a.type=e,a.frequency.value=t,a.Q.value="peaking"===e?1:1e-4,a.gain.value=0,a}async function startProcessing(e){audioContext&&(await audioContext.close().catch(()=>{}),audioContext=null);try{const t=await navigator.mediaDevices.getUserMedia({audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e}}});t.getAudioTracks()[0].onended=()=>{console.log("Stream cortado externamente"),chrome.runtime.sendMessage({type:"STREAM_ENDED_EXTERNALLY"}).catch(()=>{})},audioContext=new AudioContext,await audioContext.resume(),sourceNode=audioContext.createMediaStreamSource(t),analyser=audioContext.createAnalyser(),analyser.fftSize=256,bass=createFilter("lowshelf",100),mid=createFilter("peaking",1e3),treble=createFilter("highshelf",8e3),gainNode=audioContext.createGain(),compressor=audioContext.createDynamicsCompressor(),compressor.threshold.value=-10,compressor.ratio.value=12,sourceNode.connect(analyser),sourceNode.connect(bass).connect(mid).connect(treble).connect(gainNode).connect(compressor).connect(audioContext.destination);let a={volumeLevel:1,bassLevel:0,midLevel:0,trebleLevel:0};if("undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local)try{const e=await chrome.storage.local.get(["volumeLevel","bassLevel","midLevel","trebleLevel"]);a={...a,...e}}catch(e){}gainNode.gain.value=a.volumeLevel??1,bass.gain.value=a.bassLevel??0,mid.gain.value=a.midLevel??0,treble.gain.value=a.trebleLevel??0;const o=audioContext.createOscillator();o.frequency.value=0;const n=audioContext.createGain();n.gain.value=0,o.connect(n).connect(audioContext.destination),o.start(),o.stop(audioContext.currentTime+.001),chrome.runtime.sendMessage({type:"STATUS_UPDATE",success:!0}).catch(()=>{})}catch(e){console.error("Error captura:",e),chrome.runtime.sendMessage({type:"STATUS_UPDATE",success:!1}).catch(()=>{})}}chrome.runtime.onMessage.addListener((e,t,a)=>{if("INCOMING_STREAM"===e.type&&startProcessing(e.streamId),"TARGET_OFFSCREEN_PING"===e.type){const e=audioContext&&"closed"!==audioContext.state;let t=!1;if(e&&analyser){const e=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(e);t=e.reduce((e,t)=>e+t,0)>0}return a({success:!!e,audioDetected:t}),!1}"UPDATE_GAIN"===e.type&&gainNode&&(gainNode.gain.value=parseFloat(e.value)),"UPDATE_BASS"===e.type&&bass&&(bass.gain.value=parseFloat(e.value)),"UPDATE_MID"===e.type&&mid&&(mid.gain.value=parseFloat(e.value)),"UPDATE_TREBLE"===e.type&&treble&&(treble.gain.value=parseFloat(e.value)),("TOGGLE_ENABLED"===e.type&&!1===e.value||"STOP_CAPTURE"===e.type)&&(sourceNode?.mediaStream&&sourceNode.mediaStream.getTracks().forEach(e=>e.stop()),audioContext&&(audioContext.close(),audioContext=null),chrome.runtime.sendMessage({type:"STATUS_UPDATE",success:!1}).catch(()=>{}))});